rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================================================
    // COMBINED PRODUCTION RULES — boletapp-d609f
    // Covers both Boletapp (Gastify) and Gustify paths.
    // Deploy with: firebase deploy --only firestore:rules --project boletapp-d609f --config firebase.production.json
    // ============================================================================

    // --- Boletapp (Gastify) rules ---

    // Validate top-level field bounds (from Boletapp)
    function hasValidFieldBounds(data) {
      return (!('merchant' in data) || (data.merchant is string && data.merchant.size() >= 1 && data.merchant.size() <= 200))
        && (!('total' in data) || (data.total is number && data.total >= 0 && data.total <= 999999999));
    }

    // Boletapp transactions — owner only
    match /artifacts/{appId}/users/{userId}/transactions/{transactionId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update: if request.auth != null
        && request.auth.uid == userId
        && hasValidFieldBounds(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Collection group query deny (Boletapp security)
    match /{path=**}/transactions/{transactionId} {
      allow read: if false;
    }

    // Boletapp user data isolation (all subcollections)
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update: if request.auth != null
        && request.auth.uid == userId
        && hasValidFieldBounds(request.resource.data);
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // --- Gustify rules ---

    // Gustify user profiles and subcollections
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;

      match /pantry/{ingredientId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
      match /cookedMeals/{mealId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
      match /shoppingList/{listId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Canonical ingredients dictionary (read-only)
    match /canonicalIngredients/{id} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Item mappings (Gastify items -> canonical ingredients)
    match /itemMappings/{hash} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.source is string
        && request.resource.data.source.size() <= 200
        && request.resource.data.canonicalId is string;
      allow update, delete: if false;
    }

    // Recipes (read-only)
    match /recipes/{recipeId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // --- Catch-all deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
